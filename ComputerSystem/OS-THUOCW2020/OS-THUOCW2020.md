# 操作系统(RISC-V ed) 清华大学 [Spring 2020](http://os.cs.tsinghua.edu.cn/oscourse/OS2020spring)
<font size = 4> 向勇 & 陈渝 </font>

## 第 1 讲：操作系统概述
预备知识:<br>
* 程序设计语言（汇编、C 和 Rust(语言级别的并发和同步)）
* 数据结构 
* 计算机组成原理(Pttterson的RISC-V)
* 编译原理(影响不大)

推荐参考书:<br>
* 操作系统:三大简易元素
* 操作系统概念
* 操作系统:精髓与设计原理

教学内容: 主要与操作系统的内核有关,实验使用QEMU模拟器写一个教学操作系统<br>
![contents](figure/1.1.png)<br>

### 什么是操作系统
* 没有公认的定义, 从wiki看,操作系统是管理硬件资源、控制程序运行、改善人机界面和为应用软件提供支持的一种系统软件.<br>
    ![](figure/1.2.png)<br>
* 操作系统是一个控制程序
    * 一个系统软件,控制程序执行过程, 防止错误
    * 执行用户程序, 给程序提供服务,方便用户使用计算机系统
* 操作系统是一个资源管理程序
    * 应用程序与硬件之间的中间层,管理各种软硬件资源
    * 提供访问软硬件资源的高效手段,解决访问冲突, 确保公平使用

![system heri](figure/1.3.png)<br>
实际上, 操作系统就是一种抽象, 将CPU抽象成了进程...:<br>
![abstraction](figure/1.4.png)<br>
内核的特征:<br>
* 并发：计算机系统中同时存在多个运行程序
* 共享：程序间**同时**访问互斥共享各种资源(CPU一段时间给这个进程,一段时间给另一个,而内存则是不同段内存分给了不同的进程,他们的共享方式是不一样的)
* 虚拟：每个程序**看上去独占**一个完整的计算机(内存和磁盘都有这个问题, 看上去独立, 实际上是共享的)
* 异步：服务的完成时间不确定，也可能失败(不能用时钟去数运行了多久)

<font size=4 > 为什么学习操作系统</font>
它是一门综合的课程, 同时在计算机科学中一个基础的部分.操作系统中的关键问题:<br>
* 操作系统管理并发
* 操作系统代码必须是高效的, 低耗能，安全可靠

学习操作系统需要具有系统思维:<br>
* 操作系统并不仅仅是琐碎的调度算法
* 并发性是操作系统的一小部分内容
* 权衡资源 软硬协同

### 操作系统历史
操作系统的发展随着硬件共同演化: 
* 单用户系统: 装载器 (loader)+ 程序库 (libraries)
* 批处理系统: 装载器 (loader)+ 程序控制器 (sequencer)+ 输出处理器 (output processor)
* 多道程序系统 : 装载器 + 程序调度 + 内存管理 + 输出管理
* 分时系统: 装载器 + 程序调度 + 内存管理 + 中断处理 +...
* 个人计算机: 走向大众，老的服务和功能不存在，越来越多的安全问题
* 分布式系统: 分布式(装载器 + 程序/OS 调度 + 内存管理),重要的是:重点是网络/存储/计算的效率
* AIoT 系统: 走向设备，走向网络，新的挑战 (不可靠/大数据)

### 操作系统结构
1. 简单结构 : 在这种结构下, __常驻系统程序就是操作系统__,它在最小的空间, 设计用于提供大部分功能,没有拆分为模块,主要用汇编编写,没有安全保护.<br>
    ![simple structure](figure/1.5.png)<br>
2. 单体分层结构:到了Unix/Linux系统, 就出现了.将单体操作系统 (Monolithic OS) 划分为多层 (levels): 
    * 每层建立在低层之上
    * 最底层(layer 0),是硬件驱动 最高层(layer N)是用户界面
    * 每一层仅使用更低一层的功能和服务<br>
    ![Monolithic OS](figure/1.6.png)
3. 微内核结构: 
    * 尽可能把内核功能移到用户空间
    * 用户模块间的通信使用消息传递
    * 优点: 灵活/安全  缺点: 性能
4. 外核结构:把资源保护和资源隔离再分开, 让内核分配机器的物理资源给多个应用程序, 并让每个程序决定如何处理这些资源,操作系统的功能变成了库的一部分(LibKernel)
5. 虚拟机结构 VMM : 拟机管理器将单独的机器接口转换成很多的虚拟机, 每个虚拟机都是一个原
始计算机系统的有效副本, 并能完成所有的处理器指令。

## 第 2 讲：操作系统与系统结构和程序设计语言
### 从 OS 角度看计算机系统
有了操作系统, 机器能够同时运行多个程序, 就需要系统层面能做好 **隔离**,只要的支持技术是**虚拟内存**和**中断**.
* 强制隔离以避免对整个系统的可用性/可靠性/安全影响
* 运行的程序通常是是隔离的单元
* 防止程序 X 破坏或监视程序 Y, 防止进程干扰操作系统,错误的过程可能会试图欺骗硬件或内核

<font size=4> 主要的隔离方法</font>
1. 地址空间 (虚拟内存)
    * 程序只允许访问自己的内存
    * 每个程序如果没有许可, 则不允许访问不属于自己的内存
2. CPU 硬件中的特权模式/中断机制(硬件支持不同的特权模式, 内核模式VS用户模式)
    * 防止应用程序访问设备和敏感的 CPU 寄存器
    * 中断是异步发生，是来自处理器外部的 I/O 设备的信号的结果,硬件中断的异常处理程序通常称为中断处理程序(interrupt handle):
        * I/O设备通过向处理器芯片的一个引脚发信号，并将异常号放到系统总线上，以 触发中断；
        * 在当前指令执行完后，处理器从系统总线读取异常号，保存现场，切换到Kernel Mode；
        * 调用中断处理程序，当中断处理程序完成后，它将控制返回给下一条本来要执行 的指令。

### 从 OS 角度看 RISC-V CPU
![](figure/2.1.png) ![](figure/2.2.png)<br>

<font size=4> RISC-V 中断机制: </font>
也可由高特权模式下的软件授权低特权模式软件处理中断.

### Rust 语言与系统编程
**系统编程语言**:用于构建控制底层计算机硬件的软件系统，并提供由用于构建应用程序和服务的更高级应用程序编程语言使用的软件平台。<br>
Rust的主要特性:
* 内存 + 线程安全
* 高级语言特性
* 成熟的工具链
* 友好的助教 + 社区（OS 示例代码 + 文档）生态
* 学习 Rust 的入门门槛比较高

//TODO: 这部分没理解在看一遍