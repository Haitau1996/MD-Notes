# Linux 内核设计与实现读书笔记
## Chap 1&2: Introduction
Linux 借鉴了 Unix 的许多设计并且实现了 Unix 的 API, 但是**并没有像其他 Unix 变种那样直接使用 Unix 源代码**。通常认为操作系统是整个系统中负责完成最基本功能和系统管理的那部分，包括内核、设备驱动程序、启动引导程序、shell 等。内核是操作系统的内在核心， **系统的其他部分必须依靠内核这部分软件提供的服务**，如管理硬件、分配资源等。通常内核运行在内核态（双模操作区别于用户态）， 由下面的部分的组成：
* 负责响应中断的**中断服务程序**
* 负责管理多个进程从而分享处理器时间的**调度程序**
* 负责进程地址空间的**内存管理程序**
* 进程间通信等

用户程序通常是通过系统调用来与内核通信：<div align=center><img src="https://raw.githubusercontent.com/Haitau1996/picgo-hosting/master/img/202207160027616.png" width="40%"/></div>  
此外操作系统内核分为两大阵营： **单内核**和**微内核**（第三阵营，外核主要用于科研系统中）。
* 单内核就是把内核从整体上作为一个单独的大过程来实现，同时也运行在一个单独的地址空间上（Linux 是单内核）
* 微内核**将不同的功能解耦划分为多个独立的过程以服务的方式提供**， 这时候就不能直接调用函数， 而是要通过进程间通信（IPC）机制互通消息

## Chap 3: 进程管理
### 进程
进程**是执行期的程序**， 不但局限于一段可执行程序的代码， **是处于执行期程序以及相关资源的总和**， 如打开的文件、一个或者多个具有内存映射的内存地址以及一个或者多个执行线程。进程提供了两种虚拟机制： **虚拟处理器和虚拟内存**。  
线程是进程中活动的对象， 拥有独立的程序计数器、进程栈和进程寄存器。

### 进程描述符及任务结构
内核把链表放在一个双向链表（任务列表， task list）中， 每个项是一个被称为进程描述符的结构，它能完整地描述一个正在执行的程序(<linux/sched.h>中)： <div align=center><img src="https://raw.githubusercontent.com/Haitau1996/picgo-hosting/master/img/202207202349773.png" width="60%"/></div> 
进程的状态有 5 种， 相对于操作系统课的 running-ready-blocked, 多了个不可中断（对信号不做响应）和 `__TASK_TRACED`(被其他进程跟踪)：<div align=center><img src="https://raw.githubusercontent.com/Haitau1996/picgo-hosting/master/img/202207202353706.png" width="70%"/></div>  
Unix 系统进程间有明确地继承关系， 进程都是pid 为 1 的 init 进程的后代，并且有 parent 指针和 children 子进程链表。  

### 进程的创建
Unix 将进程的产生(spawn)步骤分解到了两个单独的函数中进行, `fork()` 和 `exec()`， 组合起来和其他系统实用的单一函数效果相似：
#### 写时拷贝
Linux 的 `fork()` 实用**写时拷贝**页实现， 内核并不复制整个进程的地址空间， 子进程以只读的方式共享父进程的资源， 只有在需要写入的时候数据才会被复制： 开销就是**复制父进程的页表以及给子进程创建唯一的进程描述符**。  
`fork()` 通过设置标志位调用系统调用 `clone()`， 再交由 `do_fork()` 完成创建进程的大部分工作：
1. 创建内核栈、thread_info 结构和 task_struct
2. 确保创建进程后进程数没有超过资源限制
3. 子进程使自己区分于父进程(许多成员要被清零或者设置为初始值)
4. 子进程状态设置为 不可中断， 保证不会立即投入运行
5. 更新 task_struct 的 flags
6. 分配幼小的 pid
7. 根据传递给 clone 的参数拷贝或者共享打开的文件、地址空间等
8. 做扫尾工作并且返回一个指向子进程的指针

除了不拷贝父进程的页表项之外， vfork 系统调用和 fork 功能相同。  

### 线程在 Linux 中的实现
Linux 的线程机制很特殊： 线程只是被视为一个**与其他进程共享某些资源的进程**， 创建时候也是调用 `clone()` 时候传递一些标志位。